<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN">
<html>
<head>
<title>Event Handling</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Doc-O-Matic" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <link rel="STYLESHEET" href="default.css" type="text/css" />

<script type="text/javascript" src="scripts.js"></script>
</head>
<body class="Element700" onload="onBodyLoadEx('frames.html', 'topic', '00126.html');" onmousedown="onBodyMouseDown();">

<!-- Begin Popups -->

<!-- End Popups -->

<!-- Begin Page Header -->
<div class="Element710" id="areafixed">
<div class="Element94">
<a href="00300.html" target="topic">USB Libraries Help</a> &gt; <a href="00207.html" target="topic">USB Device Libraries</a> &gt; <a href="00137.html" target="topic">USB Audio 2.0 Device Library</a> &gt; <a href="00129.html" target="topic">How the Library Works</a> &gt; <a href="00126.html" target="topic">Event Handling</a></div>
<div class="Element92">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element1">
MPLAB Harmony USB Stack </div>
</td><td width="25%">
<div class="Element2">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00181.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element90">
<a href="00130.html" target="topic">Previous</a> | <a href="00129.html" target="topic">Up</a> | <a href="00134.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element96">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: USB AUDDEV V2_0 Event Handling Topic Title: Event Handling)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table><div class="Element5">
Event Handling</div>
</div>
</div>

<!-- End Page Header -->

<!-- Begin Client Area -->
<div class="Element720" id="areascroll">
<div class="Element721">

<!-- Begin Page Content -->
<a name="PageContent"></a><div class="Element58">
<a name="4465736372697074696F6E"></a><div class="Element11">
<div class="Element10">
<div class="Element15">
Registering a Audio 2.0 Function Driver Callback Function</div>
<p class="Element10">
While creating a USB Audio 2.0 Device application, an event handler must be registered with the Device Layer (the Device Layer Event Handler) and every Audio 2.0 Function Driver instance (Audio 2.0 Function Driver Event Handler). The application needs to register the event handler with the Audio 2.0 Function Driver:</p>
<ul class="Element630">
<li class="Element600">For receiving Audio 2.0 Control Requests from Host like Volume Control, Mute Control, etc.</li>
<li class="Element600">For handling other events from USB Audio 2.0 Device Driver (e.g., Data Write Complete or Data Read Complete)</li>
</ul><p class="Element10">
The event handler should be registered before the USB device layer<span style="color: #FFFFFF">_</span>acknowledges the SET CONFIGURATION request from the USB Host. To ensure this, the callback function should be set in the USB_DEVICE_EVENT_CONFIGURED event that is generated by the device<span style="color: #FFFFFF">_</span>layer. The following code example shows how this can be done. </p><div class="Element13"><div class="Element12"><pre class="Element12"><i><span style="color: #008000">/* This a sample Application Device Layer Event Handler
 * Note how the USB Audio 2.0 Device Driver callback function
 * USB_DEVICE_AUDIO_2_0_EventHandlerSet()
 * is registered in the USB_DEVICE_EVENT_CONFIGURED event.  */</span></i>

<strong><span style="color: #000080">void</span></strong> APP_UsbDeviceEventCallBack( USB_DEVICE_EVENT event, <strong><span style="color: #000080">void</span></strong> * pEventData, uintptr_t context )
{
    uint8_t * configuredEventData;
    <strong><span style="color: #000080">switch</span></strong>( event )
    {
        <strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_RESET:
            <strong><span style="color: #000080">break</span></strong>;
        <strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_DECONFIGURED:
            <i><span style="color: #008000">// USB device is reset or device is de-configured.</span></i>
            <i><span style="color: #008000">// This means that USB device layer is about to de-initialize</span></i>
            <i><span style="color: #008000">// all function drivers. So close handles to previously opened</span></i>
            <i><span style="color: #008000">// function drivers.</span></i>
            <strong><span style="color: #000080">break</span></strong>;

        <strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_CONFIGURED:
            <i><span style="color: #008000">/* check the configuration */</span></i>
             <i><span style="color: #008000">/* Initialize the Application */</span></i>
            configuredEventData = pEventData;
            <strong><span style="color: #000080">if</span></strong>(*configuredEventData == 1)
            {
                USB_DEVICE_AUDIO_V2_EventHandlerSet
                (
                    0,
                    APP_USBDeviceAudioEventHandler ,
                    (uintptr_t)NULL
                );
                <i><span style="color: #008000">/* mark that set configuration is complete */</span></i>
                appData.isConfigured = <strong><span style="color: #000080">true</span></strong>;
            }
            <strong><span style="color: #000080">break</span></strong>;

        <strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_SUSPENDED:
            <strong><span style="color: #000080">break</span></strong>;

        <strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_POWER_DETECTED:
            <i><span style="color: #008000">/* Attach the device */</span></i>
            USB_DEVICE_Attach (appData.usbDevHandle);
            <strong><span style="color: #000080">break</span></strong>;

        <strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_POWER_REMOVED:
                <i><span style="color: #008000">/* VBUS is not available. We can detach the device */</span></i>
                USB_DEVICE_Detach(appData.usbDevHandle);
                <strong><span style="color: #000080">break</span></strong>;

        <strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_RESUMED:
        <strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_ERROR:
        <strong><span style="color: #000080">default</span></strong>:
            <strong><span style="color: #000080">break</span></strong>;
    }
}</pre></div></div>
<div class="Element15">
Event Handling</div>
<p class="Element10">
The Audio 2.0 Function Driver provides events to the application through the event handler function registered by the application. These events indicate:</p>
<ul class="Element630">
<li class="Element600">Completion of a read or a write data transfer</li>
<li class="Element600">Audio 2.0 Control Interface requests</li>
<li class="Element600">Completion of data and the status stages of Audio 2.0 Control Interface related control transfer</li>
</ul><p class="Element10">
The Audio 2.0 Control Interface Request events and the related control transfer events typically require the application to respond with the Device Layer Control Transfer routines to complete the control transfer. Based on the generated event, the application may be required to:</p>
<ul class="Element630">
<li class="Element600">Respond with a <a href="00658.html" target="topic">USB_DEVICE_ControlSend</a> function, which is completes the data stage of a Control Read Transfer</li>
<li class="Element600">Respond with a <a href="00657.html" target="topic">USB_DEVICE_ControlReceive</a> function, which provisions the data stage of a Control Write Transfer</li>
<li class="Element600">Respond with a <a href="00659.html" target="topic">USB_DEVICE_ControlStatus</a> function, which completes the handshake stage of the Control Transfer. The application can either STALL or Acknowledge the handshake stage through the <a href="00659.html" target="topic">USB_DEVICE_ControlStatus</a> function.</li>
</ul><p class="Element10">
The following table shows the Audio 2.0 Function Driver Control Transfer related events and the required application control transfer actions. </p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table1">
<tr>
<td class="Element65" valign="top" width="26%">
<div class="Element66">
Audio 2.0 Function Driver Control Transfer Event&nbsp;</div></td><td class="Element65" valign="top" width="74%">
<div class="Element66">
Required Application Action&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_CUR_ENTITY_SETTINGS_RECEIVED&nbsp;</div></td><td class="Element67" valign="top" width="74%">
<div class="Element68">
Identify the control type using the associated event data. If a data stage is expected, use the <a href="00657.html" target="topic">USB_DEVICE_ControlReceive</a> function to receive expected data. If a data stage is not required or if the request is not supported, use the <a href="00659.html" target="topic">USB_DEVICE_ControlStatus</a> function to Acknowledge or Stall the request.&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_RANGE_ENTITY_SETTINGS<br>_RECEIVED&nbsp;</div></td><td class="Element67" valign="top" width="74%">
<div class="Element68">
Identify the control type using the associated event data. If a data stage is expected, use the <a href="00657.html" target="topic">USB_DEVICE_ControlReceive</a> function to receive expected data. If a data stage is not required or if the request is not supported, use the <a href="00659.html" target="topic">USB_DEVICE_ControlStatus</a> function to Acknowledge or Stall the request.&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_EVENT_CONTROL_TRANSFER<br>_DATA_RECEIVED&nbsp;</div></td><td class="Element67" valign="top" width="74%">
<div class="Element68">
Acknowledge or stall using the <a href="00659.html" target="topic">USB_DEVICE_ControlStatus</a> function.&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="26%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_EVENT_CONTROL_TRANSFER<br>_DATA_SENT&nbsp;</div></td><td class="Element67" valign="top" width="74%">
<div class="Element68">
Action not required.&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
The application must analyze the wIndex field of the event data (received with the control transfer event) to identify the entity that is being addressed. The application must be aware of all entities included in the application and their IDs. Once identified, the application can then type cast the event data to entity type the specific control request type. For example, if the Host sends a control request to set the clock source for the Audio 2.0 device, the following occurs in this order:</p>
<ol class="Element630">
<li value="1" class="Element600">The Audio 2.0 Function Driver will generate a USB_DEVICE_AUDIO_V2_CUR_ENTITY_SETTINGS_RECEIVED event.</li>
<li value="2" class="Element600">The application must type cast the event data to a USB_AUDIO_V2_CONTROL_INTERFACE_REQUEST type and check the entityID field.</li>
<li value="3" class="Element600">The entityID field will be identified by the application as a Clock Source.</li>
<li value="4" class="Element600">The application must now type cast the event data type as a USB_AUDIO_V2_CLOCKSOURCE_CONTROL_REQUEST data type and check the controlSelector field.</li>
<li value="5" class="Element600">If the controlSelector field is AUDIO_V2_CS_SAM_FREQ_CONTROL, the application can then call the <a href="00657.html" target="topic">USB_DEVICE_ControlReceive</a> function to receive the clock source.</li>
</ol><p class="Element10">
Based on the type of event, the application should analyze the event data parameter of the event handler. This data member should be type cast to an event specific data type. The following table shows the event and the data type to use while type casting. Note that the event data member is not required for all events. </p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table1">
<tr>
<td class="Element65" valign="top" width="59%">
<div class="Element66">
Audio 2.0 Function Driver Event&nbsp;</div></td><td class="Element65" valign="top" width="41%">
<div class="Element66">
Related Event Data Type&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="59%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_CUR_ENTITY_SETTINGS_RECEIVED&nbsp;</div></td><td class="Element67" valign="top" width="41%">
<div class="Element68">
USB_AUDIO_V2_CONTROL_INTERFACE_REQUEST*&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="59%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_RANGE_ENTITY_SETTINGS<br>_RECEIVED<br>&nbsp;</div></td><td class="Element67" valign="top" width="41%">
<div class="Element68">
USB_AUDIO_V2_CONTROL_INTERFACE_REQUEST*&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="59%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_EVENT_CONTROL_TRANSFER<br>_DATA_RECEIVED&nbsp;</div></td><td class="Element67" valign="top" width="41%">
<div class="Element68">
NULL&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="59%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_EVENT_CONTROL_TRANSFER<br>_DATA_SENT&nbsp;</div></td><td class="Element67" valign="top" width="41%">
<div class="Element68">
NULL&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="59%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_EVENT_INTERFACE_SETTING_CHANGED&nbsp;</div></td><td class="Element67" valign="top" width="41%">
<div class="Element68">
<a href="00553.html" target="topic">USB_DEVICE_AUDIO_V2_EVENT_DATA_SET_ALTERNATE_INTERFACE</a> *&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="59%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_EVENT_READ_COMPLETE&nbsp;</div></td><td class="Element67" valign="top" width="41%">
<div class="Element68">
<a href="00552.html" target="topic">USB_DEVICE_AUDIO_V2_EVENT_DATA_READ_COMPLETE</a> *&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="59%">
<div class="Element68">
USB_DEVICE_AUDIO_V2_EVENT_WRITE_COMPLETE&nbsp;</div></td><td class="Element67" valign="top" width="41%">
<div class="Element68">
<a href="00552.html" target="topic">USB_DEVICE_AUDIO_V2_EVENT_DATA_READ_COMPLETE</a> *&nbsp;</div></td></tr></table></div></div>
<div class="Element15">
Handling Audio Control Requests:</div>
<p class="Element10">
When the <span style="color: #000000">Audio 2.0 Function Driver</span> receives an Audio 2.0 Class Specific Control Transfer Request, it passes this control transfer to the application as a <span style="color: #000000">Audio 2.0 Function Driver</span>event. The following code example shows how to handle an Audio 2.0 Control request. </p><div class="Element13"><div class="Element12"><pre class="Element12"><strong><span style="color: #000080">void</span></strong> APP_USBDeviceAudioEventHandler
(
    USB_DEVICE_AUDIO_V2_INDEX iAudio ,
    USB_DEVICE_AUDIO_V2_EVENT event ,
    <strong><span style="color: #000080">void</span></strong> * pData,
    uintptr_t context
)
{
    USB_DEVICE_AUDIO_V2_EVENT_DATA_SET_ALTERNATE_INTERFACE * interfaceInfo;
    USB_DEVICE_AUDIO_V2_EVENT_DATA_READ_COMPLETE * readEventData;
    USB_DEVICE_AUDIO_V2_EVENT_DATA_WRITE_COMPLETE * writeEventData;
   USB_AUDIO_V2_CONTROL_INTERFACE_REQUEST* controlRequest;
    <strong><span style="color: #000080">if</span></strong> ( iAudio == 0 )
    {
        <strong><span style="color: #000080">switch</span></strong> (event)
        {
            <strong><span style="color: #000080">case</span></strong> USB_DEVICE_AUDIO_V2_EVENT_READ_COMPLETE:
                readEventData = (USB_DEVICE_AUDIO_V2_EVENT_DATA_READ_COMPLETE *)pData;
                <i><span style="color: #008000">//We have received an audio frame from the Host.</span></i>
                <i><span style="color: #008000">//Now send this audio frame to Audio Codec for Playback.</span></i>

            <strong><span style="color: #000080">break</span></strong>;

            <strong><span style="color: #000080">case</span></strong> USB_DEVICE_AUDIO_V2_EVENT_WRITE_COMPLETE:

            <strong><span style="color: #000080">break</span></strong>;

            <strong><span style="color: #000080">case</span></strong> USB_DEVICE_AUDIO_V2_EVENT_INTERFACE_SETTING_CHANGED:
                <i><span style="color: #008000">//We have received a request from USB host to change the Interface-</span></i>
                <i><span style="color: #008000">//Alternate setting.</span></i>
                interfaceInfo = (USB_DEVICE_AUDIO_V2_EVENT_DATA_SET_ALTERNATE_INTERFACE *)pData;
                appData.activeInterfaceAlternateSetting = interfaceInfo-&gt;interfaceAlternateSetting;
                appData.state = APP_USB_INTERFACE_ALTERNATE_SETTING_RCVD;

            <strong><span style="color: #000080">break</span></strong>;
            <strong><span style="color: #000080">case</span></strong> USB_DEVICE_AUDIO_V2_CUR_ENTITY_SETTINGS_RECEIVED:
                controlRequest = (USB_AUDIO_V2_CONTROL_INTERFACE_REQUEST*) setupPkt;
    USB_AUDIO_V2_CLOCKSOURCE_CONTROL_REQUEST* clockSourceRequest;

        <strong><span style="color: #000080">switch</span></strong>(controlRequest-&gt;entityID)
        {
       <strong><span style="color: #000080">case</span></strong> APP_ID_CLOCK_SOURCE:
          clockSourceRequest = (USB_AUDIO_V2_CLOCKSOURCE_CONTROL_REQUEST*) controlRequest;
                     <strong><span style="color: #000080">switch</span></strong>(clockSourceRequest-&gt;controlSelector)
                    {
                          <strong><span style="color: #000080">case</span></strong> AUDIO_V2_CS_SAM_FREQ_CONTROL:
                         {
                        <strong><span style="color: #000080">if</span></strong> ((controlRequest-&gt;bmRequestType &amp; 0x80) == 0)
                        {
                            <i><span style="color: #008000">//A control write transfer received from Host. Now receive data from Host.</span></i>
                           USB_DEVICE_ControlReceive(appData.usbDevHandle, (<strong><span style="color: #000080">void</span></strong> *) &amp;(appData.clockSource), 4 );
                           appData.currentAudioControl = APP_USB_AUDIO_CLOCKSOURCE_CONTROL;
                                   }
                              <strong><span style="color: #000080">else</span></strong>
                              {
                        <i><span style="color: #008000">/*Handle Get request*/</span></i>
                        USB_DEVICE_ControlSend(appData.usbDevHandle, (<strong><span style="color: #000080">void</span></strong> *)&amp;(appData.clockSource), 4 );
                        appData.currentAudioControl = APP_USB_CONTROL_NONE;
                                }
                       }

}
                <strong><span style="color: #000080">break</span></strong>;

            <strong><span style="color: #000080">case</span></strong> USB_DEVICE_AUDIO_V2_RANGE_ENTITY_SETTINGS_RECEIVED:

                <strong><span style="color: #000080">break</span></strong>;

            <strong><span style="color: #000080">case</span></strong> USB_DEVICE_AUDIO_V2_EVENT_CONTROL_TRANSFER_DATA_RECEIVED:
                USB_DEVICE_ControlStatus(appData.usbDevHandle, USB_DEVICE_CONTROL_STATUS_OK );
                <strong><span style="color: #000080">switch</span></strong> (appData.currentAudioControl)
                {
                    <strong><span style="color: #000080">case</span></strong> APP_USB_AUDIO_MUTE_CONTROL:
                    {
                        appData.state = APP_MUTE_AUDIO_PLAYBACK;
                        appData.currentAudioControl = APP_USB_CONTROL_NONE;
                    }
                    <strong><span style="color: #000080">break</span></strong>;
                    <strong><span style="color: #000080">case</span></strong> APP_USB_AUDIO_CLOCKSOURCE_CONTROL:
                    {
                        <i><span style="color: #008000">// Handle Clock Source Control here.</span></i>
                        appData.state = APP_CLOCKSOURCE_SET;
                        appData.currentAudioControl = APP_USB_CONTROL_NONE;
                    }
                    <strong><span style="color: #000080">break</span></strong>;
                    <strong><span style="color: #000080">case</span></strong> APP_USB_AUDIO_CLOCKSELECT_CONTROL:
                    {
                        <i><span style="color: #008000">// Handle Clock Source Control here.</span></i>
                        appData.currentAudioControl = APP_USB_CONTROL_NONE;

                    }
                    <strong><span style="color: #000080">break</span></strong>;
                }
            <strong><span style="color: #000080">break</span></strong>;
            <strong><span style="color: #000080">case</span></strong>  USB_DEVICE_AUDIO_V2_EVENT_CONTROL_TRANSFER_DATA_SENT:
            <strong><span style="color: #000080">break</span></strong>;
            <strong><span style="color: #000080">default</span></strong>:
                SYS_ASSERT ( <strong><span style="color: #000080">false</span></strong> , &quot;Invalid callback&quot; );
            <strong><span style="color: #000080">break</span></strong>;
        } <i><span style="color: #008000">//end of switch ( callback )</span></i>
    }<i><span style="color: #008000">//end of if  if ( iAudio == 0 )</span></i>
}<i><span style="color: #008000">//end of function APP_AudioEventCallback</span></i></pre></div></div>
</div>
</div>
</div>
<!-- End Page Content -->

<!-- Begin Page Footer -->
<div class="Element95">
<a href="00300.html" target="topic">USB Libraries Help</a> &gt; <a href="00207.html" target="topic">USB Device Libraries</a> &gt; <a href="00137.html" target="topic">USB Audio 2.0 Device Library</a> &gt; <a href="00129.html" target="topic">How the Library Works</a> &gt; <a href="00126.html" target="topic">Event Handling</a></div>
<div class="Element93">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element3">
MPLAB Harmony USB Stack </div>
</td><td width="25%">
<div class="Element4">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00181.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element91">
<a href="00130.html" target="topic">Previous</a> | <a href="00129.html" target="topic">Up</a> | <a href="00134.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element97">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: USB AUDDEV V2_0 Event Handling Topic Title: Event Handling)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table></div>

<!-- End Page Footer -->
</div>
</div>

<!-- End Client Area -->
</body></html>