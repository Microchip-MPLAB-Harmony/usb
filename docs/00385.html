<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN">
<html>
<head>
<title>Control Transfer Events</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Doc-O-Matic" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <link rel="STYLESHEET" href="default.css" type="text/css" />

<script type="text/javascript" src="scripts.js"></script>
</head>
<body class="Element700" onload="onBodyLoadEx('frames.html', 'topic', '00385.html');" onmousedown="onBodyMouseDown();">

<!-- Begin Popups -->

<!-- End Popups -->

<!-- Begin Page Header -->
<div class="Element710" id="areafixed">
<div class="Element94">
<a href="00348.html" target="topic">USB Libraries Help</a> &gt; <a href="00239.html" target="topic">USB Device Libraries</a> &gt; <a href="00381.html" target="topic">Generic USB Device Library</a> &gt; <a href="00395.html" target="topic">Using the Library</a> &gt; <a href="00390.html" target="topic">How the Library Works</a> &gt; <a href="00389.html" target="topic">Event Handling</a> &gt; <a href="00385.html" target="topic">Control Transfer Events</a></div>
<div class="Element92">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element1">
MPLAB Harmony USB Stack </div>
</td><td width="25%">
<div class="Element2">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00213.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element90">
<a href="00389.html" target="topic">Previous</a> | <a href="00389.html" target="topic">Up</a> | <a href="00387.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element96">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: USB VENDORDEV Control Transfer Events Topic Title: Control Transfer Events)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table><div class="Element5">
Control Transfer Events</div>
</div>
</div>

<!-- End Page Header -->

<!-- Begin Client Area -->
<div class="Element720" id="areascroll">
<div class="Element721">

<!-- Begin Page Content -->
<a name="PageContent"></a><div class="Element58">
<a name="4465736372697074696F6E"></a><div class="Element11">
<div class="Element10">
<p class="Element10">
These events occur when the Device Layer has received a control transfer that is targeted to an interface or an endpoint which is managed by the Generic USB Device Application. The USB_DEVICE_EVENT_CONTROL_TRANSFER_SETUP_REQUEST event is generated when the Setup stage of the control transfer has been received. The application must investigate the 8-byte setup command that accompanies this event. The following flowchart explains the interaction.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
The application can then either choose to continue the control transfer or stall it. The control transfer is stalled by calling the <a href="00719.html" target="topic">USB_DEVICE_ControlStatus</a> function with the USB_DEVICE_CONTROL_STATUS_ERROR flag. In case of zero data stage control transfers, the application can complete the control transfer by calling the <a href="00719.html" target="topic">USB_DEVICE_ControlStatus</a> function with the USB_DEVICE_CONTROL_STATUS_OK flag. In case of control transfers that contain a data stage, the application must use the <a href="00718.html" target="topic">USB_DEVICE_ControlSend</a> or the <a href="00717.html" target="topic">USB_DEVICE_ControlReceive</a> function to send and receive data from the Host, respectively.&nbsp;</p>
<p class="Element10">
In a case where data is to be received from the host, the device layer generates USB_DEVICE_EVENT_CONTROL_TRANSFER_DATA_RECEIVED event when the data stage has completed. The application can analyze the received data and can then either choose to acknowledge or stall the control transfer by the calling the <a href="00719.html" target="topic">USB_DEVICE_ControlStatus</a> function with the USB_DEVICE_CONTROL_STATUS_ERROR flag. This is shown in the following flow chart.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
The following code shows an example of handling control transfer in a Generic USB Device. Note that the control transfer events are generated by the Device Layer. </p><div class="Element13"><div class="Element12"><pre class="Element12"><i><span style="color: #008000">/* This code shows an example of how the control transfer events
 * can be handled in a Generic USB Device. The example device will accepts the
 * Set Interface Control Request and replies to the Get Interface Control Request
 * with the current alternate setting. */</span></i>
<strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_CONTROL_TRANSFER_SETUP_REQUEST:
    <i><span style="color: #008000">/* This means we have received a setup packet */</span></i>
       setupPacket = (USB_SETUP_PACKET *)eventData;
    <strong><span style="color: #000080">if</span></strong>(setupPacket-&gt;bRequest == USB_REQUEST_SET_INTERFACE)
    {
        <i><span style="color: #008000">/* If we have got the SET_INTERFACE request, we just acknowledge
         * for now. In this example, there is one alternate setting which
         * is already active. */</span></i>
        USB_DEVICE_ControlStatus(appData.usbDevHandle,USB_DEVICE_CONTROL_STATUS_OK);
    }
    <strong><span style="color: #000080">else</span></strong> <strong><span style="color: #000080">if</span></strong>(setupPacket-&gt;bRequest == USB_REQUEST_GET_INTERFACE)
    {
        <i><span style="color: #008000">/* We have only one alternate setting and this setting 0. So
        * we send this information to the host. */</span></i>
        USB_DEVICE_ControlSend(appData.usbDevHandle, &amp;appData.altSetting, 1);
    }
    <strong><span style="color: #000080">else</span></strong>
    {
        <i><span style="color: #008000">/* We have received a request that we cannot handle. Stall it*/</span></i>
        USB_DEVICE_ControlStatus(appData.usbDevHandle, USB_DEVICE_CONTROL_STATUS_ERROR);
    }
    <strong><span style="color: #000080">break</span></strong>;
<strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_CONTROL_TRANSFER_DATA_SENT:
    <i><span style="color: #008000">/* This is a notification event which the application can use to free
     * buffer that was used in a USB_DEVICE_ControlSend() function. */</span></i>
    <strong><span style="color: #000080">break</span></strong>;
<strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_CONTROL_TRANSFER_DATA_RECEIVED:
    <i><span style="color: #008000">/* This event means that data has been received in the control transfer
     * and the application must either stall or acknowledge the data stage
     * by calling the USB_DEVICE_ControlStatus() function. Here we simply
     * acknowledge the received data. This is an example only. */</span></i>
    USB_DEVICE_ControlStatus(appData.usbDevHandle, USB_DEVICE_CONTROL_STATUS_OK);
    <strong><span style="color: #000080">break</span></strong>;</pre></div></div>
</div>
</div>
</div>
<!-- End Page Content -->

<!-- Begin Page Footer -->
<div class="Element95">
<a href="00348.html" target="topic">USB Libraries Help</a> &gt; <a href="00239.html" target="topic">USB Device Libraries</a> &gt; <a href="00381.html" target="topic">Generic USB Device Library</a> &gt; <a href="00395.html" target="topic">Using the Library</a> &gt; <a href="00390.html" target="topic">How the Library Works</a> &gt; <a href="00389.html" target="topic">Event Handling</a> &gt; <a href="00385.html" target="topic">Control Transfer Events</a></div>
<div class="Element93">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element3">
MPLAB Harmony USB Stack </div>
</td><td width="25%">
<div class="Element4">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00213.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element91">
<a href="00389.html" target="topic">Previous</a> | <a href="00389.html" target="topic">Up</a> | <a href="00387.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element97">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: USB VENDORDEV Control Transfer Events Topic Title: Control Transfer Events)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table></div>

<!-- End Page Footer -->
</div>
</div>

<!-- End Client Area -->
</body></html>