<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN">
<html>
<head>
<title>Event Handling</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Doc-O-Matic" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <link rel="STYLESHEET" href="default.css" type="text/css" />

<script type="text/javascript" src="scripts.js"></script>
</head>
<body class="Element700" onload="onBodyLoadEx('frames.html', 'topic', '00202.html');" onmousedown="onBodyMouseDown();">

<!-- Begin Popups -->

<!-- End Popups -->

<!-- Begin Page Header -->
<div class="Element710" id="areafixed">
<div class="Element94">
<a href="00278.html" target="topic">USB Libraries Help</a> &gt; <a href="00168.html" target="topic">USB Device Libraries</a> &gt; <a href="00170.html" target="topic">USB Device Printer Library</a> &gt; <a href="00212.html" target="topic">Using the Library</a> &gt; <a href="00205.html" target="topic">How the Library Works</a> &gt; <a href="00202.html" target="topic">Event Handling</a></div>
<div class="Element92">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element1">
MPLAB Harmony USB Stack </div>
</td><td width="25%">
<div class="Element2">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00066.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element90">
<a href="00207.html" target="topic">Previous</a> | <a href="00205.html" target="topic">Up</a> | <a href="00211.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element96">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: USB DEVPrinter Event Handling Topic Title: Event Handling)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table><div class="Element5">
Event Handling</div>
</div>
</div>

<!-- End Page Header -->

<!-- Begin Client Area -->
<div class="Element720" id="areascroll">
<div class="Element721">

<!-- Begin Page Content -->
<a name="PageContent"></a><div class="Element58">
<a name="4465736372697074696F6E"></a><div class="Element11">
<div class="Element10">
<p class="Element10">
<strong>Registering a Printer Function Driver Event Handler</strong>&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
While creating an USB Printer Device-based application, an event handler must be registered with the Device Layer (the Device Layer Event Handler) and every Printer Function Driver instance (Printer Function Driver Event Handler). The Printer Function Driver event handler receives Printer events. This event handler should be registered before the USB device layer acknowledges the SET CONFIGURATION request from the USB Host. To ensure this, the event handler should be set in the USB_DEVICE_EVENT_CONFIGURED event that is generated by the device layer. While registering the Printer Function Driver event handler, the Printer Function Driver allows the application to also pass a data object in the event handler register function.&nbsp;</p>
<p class="Element10">
This data object gets associated with the instance of the Printer Function Driver and is returned by the Printer Function Driver when a Printer Function Driver event occurs. The following code shows an example of how this can be done.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
This below code is a sample of Application Device Layer Event Handler.&nbsp;</p>
<p class="Element10">
Note how the Printer Function Driver event handler APP_USBDevicePrinterEventHandler is registered in the USB_DEVICE_EVENT_CONFIGURED event.&nbsp;</p>
<p class="Element10">
The appData object that is passed in the <a href="00860.html" target="topic">USB_DEVICE_PRINTER_EventHandlerSet</a> function will be returned as the userData parameter in the when the APP_USBDevicePrinterEventHandler function is invoked.&nbsp;</p>
<p class="Element10">
&nbsp;</p><div class="Element13"><div class="Element12"><pre class="Element12"><i><span style="color: #008000">/***********************************************
 * Application USB Device Layer Event Handler.
 ***********************************************/</span></i>
<strong><span style="color: #000080">void</span></strong> APP_USBDeviceEventHandler
(
    USB_DEVICE_EVENT event,
    <strong><span style="color: #000080">void</span></strong> * eventData,
    uintptr_t context
)
{
    USB_DEVICE_EVENT_DATA_CONFIGURED *configuredEventData;

    <strong><span style="color: #000080">switch</span></strong>(event)
    {
        <strong><span style="color: #000080">case</span></strong> USB_DEVICE_EVENT_CONFIGURED:

            <i><span style="color: #008000">/* Check the configuration. We only support configuration 1 */</span></i>
            configuredEventData = (USB_DEVICE_EVENT_DATA_CONFIGURED*)eventData;

            <strong><span style="color: #000080">if</span></strong> ( configuredEventData-&gt;configurationValue == 1)
            {
                <i><span style="color: #008000">/* Update LED to show configured state */</span></i>
                LED_On();

                <i><span style="color: #008000">/* Register the Printer Device application event handler here.
                 * Note how the appData object pointer is passed as the
                 * user data */</span></i>

USB_DEVICE_PRINTER_EventHandlerSet(USB_DEVICE_PRINTER_INDEX_0,
          APP_USBDevicePrinterEventHandler, (uintptr_t)&amp;appData);

                <i><span style="color: #008000">/* Mark that the device is now configured */</span></i>
                appData.isConfigured = <strong><span style="color: #000080">true</span></strong>;
            }
        <strong><span style="color: #000080">break</span></strong>;
    }
}</pre></div></div>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
The Printer Function Driver event handler executes in an interrupt context when the device stack is configured for Interrupt mode. In Polled mode, the event handler is invoked in the context of the SYS_Tasks function. The application should not call computationally intensive functions, blocking functions, functions that are not interrupt safe, or functions that poll on hardware conditions from the event handler. Doing so will affect the ability of the USB device stack to respond to USB events and could potentially make the USB device non-compliant.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
<strong>Printer Function Driver Events</strong>&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
The Printer Function Driver generates events to which the application must respond. Some of these events are management requests communicated through control transfers. Therefore, the application must use the Device Layer Control Transfer routines to complete the control transfer. Based on the generated event, the application may be required to:&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
• Respond with a <a href="00648.html" target="topic">USB_DEVICE_ControlSend</a> function, which is completes the data stage of a Control Read Transfer&nbsp;</p>
<p class="Element10">
• Respond with a <a href="00647.html" target="topic">USB_DEVICE_ControlReceive</a> function, which provisions the data stage of a Control Write Transfer&nbsp;</p>
<p class="Element10">
• Respond with a <a href="00649.html" target="topic">USB_DEVICE_ControlStatus</a> function, which completes the handshake stage of the Control Transfer. The&nbsp;</p>
<p class="Element10">
application can either STALL or Acknowledge the handshake stage via the <a href="00649.html" target="topic">USB_DEVICE_ControlStatus</a> function. The following table shows the Printer Function Driver Control Transfer related events and the required application control transfer actions.&nbsp;</p>
<p class="Element10">
&nbsp;</p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table1">
<tr>
<td class="Element65" valign="top" width="40%">
<div class="Element66">
Printer Function Driver Control Transfer Event&nbsp;</div></td><td class="Element65" valign="top" width="60%">
<div class="Element66">
Required Application Action&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="40%">
<div class="Element68">
USB_DEVICE_PRINTER_GET_PORT_STATUS&nbsp;</div></td><td class="Element67" valign="top" width="60%">
<div class="Element68">
Call <a href="00648.html" target="topic">USB_DEVICE_ControlSend</a>() function to send the response data for GET_PORT_STATUS request.&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
Based on the type of event, the application should analyze the pData member of the event handler. This data member should be type cast to an event specific data type. The following table shows the event and the data type to use while type casting.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
Note that the pData member is not required for all events&nbsp;</p>
<p class="Element10">
&nbsp;</p><div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table1">
<tr>
<td class="Element65" valign="top" width="50%">
<div class="Element66">
Printer Function Driver Event&nbsp;</div></td><td class="Element65" valign="top" width="50%">
<div class="Element66">
Related pData type&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="50%">
<div class="Element68">
USB_DEVICE_PRINTER_EVENT_WRITE_COMPLETE&nbsp;</div></td><td class="Element67" valign="top" width="50%">
<div class="Element68">
<a href="00856.html" target="topic">USB_DEVICE_PRINTER_EVENT_DATA_WRITE_COMPLETE</a>&nbsp;</div></td></tr><tr>
<td class="Element67" valign="top" width="50%">
<div class="Element68">
USB_DEVICE_PRINTER_EVENT_READ_COMPLETE&nbsp;</div></td><td class="Element67" valign="top" width="50%">
<div class="Element68">
<a href="00852.html" target="topic">USB_DEVICE_PRINTER_EVENT_DATA_READ_COMPLETE</a>&nbsp;</div></td></tr></table></div></div>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
The possible Printer Function Driver events are described here with the required application response, event specific data, and likely follow-up function driver event:&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
<strong>USB_DEVICE_PRINTER_EVENT_WRITE_COMPLETE</strong>&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
<i>Application Response: </i>This event occurs when a write operation scheduled by calling the <a href="00891.html" target="topic">USB_DEVICE_PRINTER_Write</a>() function has completed. This event does not require the application to respond with any function calls.&nbsp;</p>
<p class="Element10">
<i>Event Specific Data (pData): </i>The pData member in the event handler will point to the&nbsp;</p>
<p class="Element10">
<a href="00856.html" target="topic">USB_DEVICE_PRINTER_EVENT_DATA_WRITE_COMPLETE</a> data type.&nbsp;</p>
<p class="Element10">
<i>Likely Follow-up event: </i>None.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
<strong>USB_DEVICE_PRINTER_EVENT_READ_COMPLETE</strong>&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
<i>Application Response:</i> This event occurs when a read operation scheduled by calling the <a href="00875.html" target="topic">USB_DEVICE_PRINTER_Read</a> function has completed. This event does not require the application to respond with any function calls.&nbsp;</p>
<p class="Element10">
<i>Event Specific Data (pData): </i>The pData member in the event handler will point to the&nbsp;</p>
<p class="Element10">
<a href="00852.html" target="topic">USB_DEVICE_PRINTER_EVENT_DATA_READ_COMPLETE</a> type.&nbsp;</p>
<p class="Element10">
<i>Likely Follow-up event:</i> None.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
<strong>Printer Function Driver Event Handling</strong>&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
The following code shows an event handling scheme example. The application always returns from the event handler with a <a href="00859.html" target="topic">USB_DEVICE_PRINTER_EVENT_RESPONSE_NONE</a> value.&nbsp;</p>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
The below code example shows all Printer Function Driver possible events and a possible scheme for handling these events. In this case event responses are not deferred.&nbsp;</p>
<p class="Element10">
&nbsp;</p><div class="Element13"><div class="Element12"><pre class="Element12"><i><span style="color: #008000">/*******************************************************
 * USB PRINTER Device Events - Application Event Handler
 *******************************************************/</span></i>

USB_DEVICE_PRINTER_EVENT_RESPONSE APP_USBDevicePrinterEventHandler
(
    USB_DEVICE_PRINTER_INDEX index,
    USB_DEVICE_PRINTER_EVENT event,
    <strong><span style="color: #000080">void</span></strong> * pData,
    uintptr_t userData
)
{
  APP_DATA * appDataObject;
  USB_DEVICE_PRINTER_EVENT_DATA_READ_COMPLETE * eventDataRead;
  uint8_t prntrStatus;
  appDataObject = (APP_DATA *)userData;
  <strong><span style="color: #000080">switch</span></strong>(event)
  {
    <strong><span style="color: #000080">case</span></strong> USB_DEVICE_PRINTER_GET_PORT_STATUS:
       <i><span style="color: #008000">/* This means the host wants to know the printer's current status,
        * in a format which is compatible with the status register of a
        * standard PC parallel port. This is a control transfer request.
        * Use the USB_DEVICE_ControlSend() function to send the data to
        * host. */</span></i>
       prntrStatus = (uint8_t)(((appDataObject-&gt;portStatus.errorStatus &lt;&lt; 3) &amp; 0x08) |
                ((appDataObject-&gt;portStatus.selectStatus &lt;&lt; 4) &amp; 0x10) |
                ((appDataObject-&gt;portStatus.paperEmptyStatus &lt;&lt; 5) &amp; 0x20));

       USB_DEVICE_ControlSend( appDataObject-&gt;deviceHandle, &amp;prntrStatus, 1 );
       <strong><span style="color: #000080">break</span></strong>;

    <strong><span style="color: #000080">case</span></strong> USB_DEVICE_PRINTER_EVENT_READ_COMPLETE:
       <i><span style="color: #008000">/* This means that the host has sent some data*/</span></i>
       eventDataRead = (USB_DEVICE_PRINTER_EVENT_DATA_READ_COMPLETE *)pData;
       appDataObject-&gt;isReadComplete = <strong><span style="color: #000080">true</span></strong>;
       appDataObject-&gt;numBytesRead = eventDataRead-&gt;length;
       <strong><span style="color: #000080">break</span></strong>;

    <strong><span style="color: #000080">case</span></strong> USB_DEVICE_PRINTER_EVENT_WRITE_COMPLETE:
       <i><span style="color: #008000">/* This means that the data write got completed */</span></i>
       appDataObject-&gt;isWriteComplete = <strong><span style="color: #000080">true</span></strong>;
       <strong><span style="color: #000080">break</span></strong>;
    <strong><span style="color: #000080">default</span></strong>:
       <strong><span style="color: #000080">break</span></strong>;
    }
    <strong><span style="color: #000080">return</span></strong> USB_DEVICE_PRINTER_EVENT_RESPONSE_NONE;
}
</pre></div></div>
<p class="Element10">
&nbsp;</p>
<p class="Element10">
Refer to the <a href="00848.html" target="topic">USB_DEVICE_PRINTER_EVENT</a> enumeration for more details on each event.</p></div>
</div>
</div>
<!-- End Page Content -->

<!-- Begin Page Footer -->
<div class="Element95">
<a href="00278.html" target="topic">USB Libraries Help</a> &gt; <a href="00168.html" target="topic">USB Device Libraries</a> &gt; <a href="00170.html" target="topic">USB Device Printer Library</a> &gt; <a href="00212.html" target="topic">Using the Library</a> &gt; <a href="00205.html" target="topic">How the Library Works</a> &gt; <a href="00202.html" target="topic">Event Handling</a></div>
<div class="Element93">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element3">
MPLAB Harmony USB Stack </div>
</td><td width="25%">
<div class="Element4">
<a href="contents.html" target="tocidx">Contents</a> | <a href="00066.html" target="topic">Home</a></div>
</td><td width="25%">
<div class="Element91">
<a href="00207.html" target="topic">Previous</a> | <a href="00205.html" target="topic">Up</a> | <a href="00211.html" target="topic">Next</a></div>
</td><td width="25%">
<div class="Element97">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: USB DEVPrinter Event Handling Topic Title: Event Handling)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com" target="_blank">Microchip Support</a></div>
</td></tr></table></div>

<!-- End Page Footer -->
</div>
</div>

<!-- End Client Area -->
</body></html>